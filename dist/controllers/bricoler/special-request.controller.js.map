{"version":3,"sources":["../../../src/controllers/bricoler/special-request.controller.js"],"names":["_","validateBody","isUpdate","validations","exists","withMessage","createNewSpecialRequest","req","res","next","validationErrors","array","length","ApiError","bricolerId","params","files","body","imgs","x","push","lang","lat","requestLocation","location","dueDate","parseInt","user","id","bricoler","SpecialRequest","create","newDoc","findById","populate","createdDoc","historyObject","serviceType","service","status","History","historyDoc","Notification","targetUser","subjectType","subject","text","newNoti","title","json","retriveOneRequestDetails","User","bricolerDetails","end","requestId","requestDetails","acceptRequest","save","historyQuery","findOne","console","log","ignoreRequst"],"mappings":"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","file":"special-request.controller.js","sourcesContent":["import User from '../../models/user.model';\nimport SpecialRequest from '../../models/special-request.model';\nimport History from '../../models/history.model';\nimport Notification from '../../models/notification.model';\n\nimport mongoose from 'mongoose';\nimport ApiResponse from '../../helpers/ApiResponse';\nimport ApiError from '../../helpers/ApiError';\nimport { body, param, validationResult } from 'express-validator/check';\nimport { escapeRegExp } from 'lodash';\nimport * as _ from 'lodash';\nimport { toImgUrl } from '../../utils/index'\nimport { send } from '../../services/push-notifications';\n\nexport default {\n\n    //validation for create new request\n    validateBody(isUpdate = false) {\n        let validations = [\n            body(\"title\").exists().withMessage(\"title is required\"),\n            body(\"description\").exists().withMessage(\"descripption is required\"),\n            body('lang').exists().withMessage(\"lang  is required\"),\n            body(\"lat\").exists().withMessage(\"lat is required\"),\n            body(\"dueDate\").exists().withMessage(\"dueDate is required\")\n        ];\n        return validations;\n    },\n\n    async createNewSpecialRequest(req, res, next) {\n        try {\n            const validationErrors = validationResult(req).array();\n            if (validationErrors.length > 0)\n                return next(new ApiError(422, validationErrors));\n\n\n            let bricolerId = req.params.bricolerId;\n            //prepare data \n            if (req.files.length > 0) {\n                req.body.imgs = []\n                for (let x = 0; x < req.files.length; x++) {\n                    req.body.imgs.push(await toImgUrl(req.files[x]))\n                }\n            }\n            let lang = req.body.lang;   //long\n            let lat = req.body.lat;//lat\n            let requestLocation = [lang, lat] //modify location \n            req.body.location = requestLocation;\n            req.body.dueDate = parseInt(req.body.dueDate)\n            req.body.user = req.user.id;\n            req.body.bricoler = bricolerId;\n\n            //create new doc \n            let newDoc = await SpecialRequest.create(req.body);\n            let createdDoc = await SpecialRequest.findById(newDoc.id)\n                .populate('user')\n                .populate('bricoler')\n\n            //create history doc \n            let historyObject = {\n                serviceType: 'special-request',\n                service: createdDoc.id,\n                user: createdDoc.user,\n                bricoler: createdDoc.bricoler,\n                status: 'pendding'\n            }\n            let historyDoc = await History.create(historyObject);\n\n\n            //in app notification \n            let newNoti = await Notification.create({\n                targetUser: createdDoc.bricoler,\n                subjectType: 'special-request',\n                subject: createdDoc.id,\n                text: 'يطلب منك أحد العملاء خدمة جديدة',\n            });\n\n            //send notifications\n            let title = \"يطلب منك أحد العملاء خدمة جديدة\";\n            let body = \"يطلب منك أحد العملاء خدمة جديدة, يرجى التحقق من ذلك والعمل بجد للفوز\"\n            send(createdDoc.bricoler, title, body)\n\n            return res.status(201).json(createdDoc);\n\n        } catch (err) {\n            next(err)\n        }\n    },\n\n    //retrive one request \n    async retriveOneRequestDetails(req, res, next) {\n        try {\n            let bricolerId = req.params.bricolerId;\n            let bricolerDetails = await User.findById(bricolerId);\n            if (!bricolerDetails)\n                res.status(404).end();\n            let requestId = req.params.requestId;\n            let requestDetails = await SpecialRequest.findById(requestId)\n                .populate('user')\n                .populate('bricoler')\n            if (!requestDetails)\n                return res.status(404).end()\n            return res.status(200).json(requestDetails);\n        } catch (err) {\n            next(err)\n        }\n    },\n\n    //accept request by bricoler \n    async acceptRequest(req, res, next) {\n        try {\n\n            let bricolerId = req.params.bricolerId;\n            let bricolerDetails = await User.findById(bricolerId);\n            if (!bricolerDetails)\n                res.status(404).end();\n\n            let requestId = req.params.requestId;\n            let requestDetails = await SpecialRequest.findById(requestId)\n            if (!requestDetails)\n                return res.status(404).end();\n\n            if (!(req.user.id == requestDetails.bricoler))\n                next(new ApiError(403, 'must bricoler only can accept it'));\n\n            requestDetails.status = \"accepted\";\n            await requestDetails.save();\n\n            let newDoc = await SpecialRequest.findById(requestDetails.id)\n                .populate('user')\n                .populate('bricoler')\n\n            //update bricole history \n            let historyQuery = {\n                serviceType: 'special-request',\n                service: requestDetails.id,\n                user: requestDetails.user,\n                bricoler: requestDetails.bricoler\n            }\n            let historyDoc = await History.findOne(historyQuery);\n            console.log(historyDoc)\n            historyDoc.status = \"accepted\";\n            await historyDoc.save();\n\n            //in app notification \n            let newNoti = await Notification.create({\n                targetUser: newDoc.user,\n                subjectType: 'special-request',\n                subject: newDoc.id,\n                text: 'تم قبول طلبك من مزود الخدمة',\n            });\n\n            //send notifications\n            let title = \"تم قبول طلبك من مزود الخدمة\";\n            let body = \"تم قبول طلبك من مزود الخدمة, يرجى أن تكون متصلا به دائما\"\n            send(newDoc.user, title, body)\n\n            //return responce \n            return res.status(200).json(newDoc);\n\n        } catch (err) {\n            next(err)\n        }\n    },\n    //ignore request by bricoler \n    async ignoreRequst(req, res, next) {\n        try {\n\n            let bricolerId = req.params.bricolerId;\n            let bricolerDetails = await User.findById(bricolerId);\n            if (!bricolerDetails)\n                res.status(404).end();\n\n            let requestId = req.params.requestId;\n            let requestDetails = await SpecialRequest.findById(requestId)\n            if (!requestDetails)\n                return res.status(404).end();\n\n            if (!(req.user.id == requestDetails.bricoler))\n                next(new ApiError(403, 'must bricoler only can ignored it'));\n\n            requestDetails.status = \"ignored\";\n            await requestDetails.save();\n\n            let newDoc = await SpecialRequest.findById(requestDetails.id)\n                .populate('user')\n                .populate('bricoler')\n\n            //update bricole history\n            console.log(requestDetails.id)\n            console.log(requestDetails.user)\n            console.log(requestDetails.bricoler)\n            let historyQuery = {\n                serviceType: 'special-request',\n                service: requestDetails.id,\n                user: requestDetails.user,\n                bricoler: requestDetails.bricoler\n            }\n            let historyDoc = await History.findOne(historyQuery);\n            console.log(historyDoc)\n            historyDoc.status = \"ignored\";\n            await historyDoc.save();\n            //return responce \n\n            //in app notification \n            let newNoti = await Notification.create({\n                targetUser: newDoc.user,\n                subjectType: 'special-request',\n                subject: newDoc.id,\n                text: 'نحن نأسف لرفض طلبك من مزود الخدمة',\n            });\n\n            //send notifications\n            let title = \"نحن نأسف لرفض طلبك من مزود الخدمة\";\n            let body = \"نحن نأسف لرفض طلبك من مزود الخدمة , يمكن أن يكون مشغولاً الآن ولا يمكنه مساعدتك\"\n            send(newDoc.user, title, body)\n\n            return res.status(200).json(newDoc);\n\n        } catch (err) {\n            next(err)\n        }\n    }\n}\n\n\n"]}